#!/usr/bin/perl
use strict;
use warnings;

my $file = $ARGV[0] || 'Mirrors.masterlist';
die "no file $file" unless -f $file;

open(my $fh, '<', $file) or die "Could not open $file: $!";

my @mirrors;
my $data;
my $line_num = 0;
my $errors = 0;

while (my $line = <$fh>) {
    $line_num++;
    chomp $line;
    if ($line =~ /([^:]+): (.*)/) {
        my $key = lc($1);
        my $value = $2;
        $data->{$key} = $value;
    } elsif ($line eq '') {
        if ($data) {
            # Validate required fields
            unless ($data->{site}) {
                print "ERROR: Entry missing Site field around line $line_num\n";
                $errors++;
            }
            unless ($data->{type}) {
                print "ERROR: Entry missing Type field for site " . ($data->{site} || "unknown") . "\n";
                $errors++;
            }
            unless ($data->{country}) {
                print "ERROR: Entry missing Country field for site " . ($data->{site} || "unknown") . "\n";
                $errors++;
            }
            push @mirrors, $data;
        }
        $data = undef;
    } else {
        print "WARNING: Malformed line $line_num: $line\n";
    }
}

# Check last entry if file does not end with blank line
if ($data) {
    unless ($data->{site}) {
        print "ERROR: Last entry missing Site field\n";
        $errors++;
    }
    unless ($data->{type}) {
        print "ERROR: Last entry missing Type field for site " . ($data->{site} || "unknown") . "\n";
        $errors++;
    }
    unless ($data->{country}) {
        print "ERROR: Last entry missing Country field for site " . ($data->{site} || "unknown") . "\n";
        $errors++;
    }
    push @mirrors, $data;
}

if ($errors > 0) {
    print "Found $errors syntax errors in masterlist\n";
    exit(1);
} else {
    print "Masterlist syntax validation passed (" . @mirrors . " entries)\n";
}